version: "2.2"
services:
  flask-app:
    depends_on:
      - redis
    image: jerehops/fyp-flask:9
    container_name: flask
    command: flask run --host=0.0.0.0
    ports:
      - 8000:8000
    volumes:
      - data:/opt/data/uploads
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -s -I http://localhost:8000 | grep -q 'HTTP/1.1 302 Found'",
        ]
      interval: 10s
      timeout: 10s
      retries: 120
  celery:
    depends_on:
      - redis
    image: jerehops/fyp-flask:9
    container_name: celery
    command: celery -A app.process worker --loglevel=info
  redis:
    image: redis:6-alpine
    container_name: redis
    ports:
      - '6379:6379'
  spark-master:
    image: jerehops/fyp-spark:latest
    container_name: spark-master
    ports:
      - 8080:8080
      - 7077:7077
    volumes:
      - data:/opt/data/uploads
      - scripts:/opt/scripts
  spark-worker-1:
    image: jerehops/fyp-sparkworker:latest
    container_name: spark-master
    ports:
      - 8082:8081
    volumes:
      - data:/opt/data/uploads
      - scripts:/opt/scripts
  spark-worker-2:
    image: jerehops/fyp-sparkworker:latest
    container_name: spark-master
    ports:
      - 8082:8081
    volumes:
      - data:/opt/data/uploads
      - scripts:/opt/scripts
  spark-worker-3:
    image: jerehops/fyp-sparkworker:latest
    container_name: spark-master
    ports:
      - 8082:8081
    volumes:
      - data:/opt/data/uploads
      - scripts:/opt/scripts
volumes:
  data:
    driver: local
  scripts:
    driver: local